<!DOCTYPE html>
<html>
	<head>
		<base target="_top">
		<!-- apply Google styling to buttons and other elements -->
		<link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
		<style>
			.width-100 {
				width: 100%;
				box-sizing: border-box;
				-webkit-box-sizing: border-box;
				-moz-box-sizing: border-box;
			}
		</style>
	</head>
	<body>
		<div class="sidebar">
			<form id="settings-form">
				<h3>Google Forms settings</h3>
				
				<!-- first name question -->
				<div class="block form-group" id="respondent-notify">
					
					<label for="respondent-first-name">
						Which question asks for first name?
					</label>
					<select id="respondent-first-name" class="width-100">
						<option value="none">Not collecting first names</option>
					</select>

					<br>

					<!-- last name question -->
					<label for="respondent-last-name">
						Which question asks for last name?
					</label>
					<select id="respondent-last-name" class="width-100">
						<option value="none">Not collecting last names</option>
					</select>

					<br>

					<!-- phone number question -->
					<label for="respondent-phone-number">
						Which question asks for phone number?
					</label>
					<select id="respondent-phone-number" class="width-100">
						<option value="none">Not collecting phone numbers</option>
					</select>
				</div>

				<div class="block" id="button-bar">
					<button class="action" id="save-settings">Save</button>
				</div>
			</form>
		</div>

		<!-- include jQuery -->
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

		<script>
			// assign handlers to elements 
			$(function() {
				$('#save-settings').click(saveSettingsToServer);
				google.script.run
				.withSuccessHandler(loadSettings)
				.withFailureHandler(showStatus)
				.withUserObject($('#button-bar').get())
				.getSettings();
			});


			// load settings
			function loadSettings(settings) {
				// fill the 'First name' select box with titles
				settings.textItems.forEach(function(textItem){
					var option = $('<option>')
					.attr('value', textItem['id'])
					.text(textItem['title']);
					$('#respondent-first-name').append(option);
				});

				// fill the 'Last name' select box with titles
				settings.textItems.forEach(function(textItem){
					var option = $('<option>')
					.attr('value', textItem['id'])
					.text(textItem['title']);
					$('#respondent-last-name').append(option);
				});

				// fill the 'Phone number' select box with titles
				settings.textItems.forEach(function(textItem){
					var option = $('<option>')
					.attr('value', textItem['id'])
					.text(textItem['title']);
					$('#respondent-phone-number').append(option);
				});
				
				// populate fields with current settings
				if (settings.firstNameField) {
					$('#respondent-first-name option[value="'+settings.firstNameField+'"]').attr('selected', 'selected');
				}
				
				if (settings.lastNameField) {
					$('#respondent-last-name option[value="'+settings.lastNameField+'"]').attr('selected', 'selected');
				}
				
				if (settings.phoneNumberField) {
					$('#respondent-phone-number option[value="'+settings.phoneNumberField+'"]').attr('selected', 'selected');
				}
			}

			// collect settings and send them to be saved as Properties on the server
			function saveSettingsToServer() {
				this.disabled = true;

				var firstNameField = $('#respondent-first-name').val();
				var lastNameField = $('#respondent-last-name').val();
				var phoneNumberField = $('#respondent-phone-number').val();

				var settings = {
					'firstNameField' : firstNameField,
					'lastNameField' : lastNameField,
					'phoneNumberField' : phoneNumberField
				};

				// save settings on the server
				// Save the settings on the server
				google.script.run
				.withSuccessHandler(
					function(msg, element) {
						showStatus('Saved settings', $('#button-bar'));
						element.disabled = false;
					})
				.withFailureHandler(
					function(msg, element) {
						showStatus(msg, $('#button-bar'));
						element.disabled = false;
					})
				.withUserObject(this)
				.saveSettings(settings);
			}

			// insert a div with a status message after a given element
			function showStatus(msg, element) {
				var div = $('<div>')
				.attr('id', 'status')
				.attr('class','error')
				.text(msg);
				$(element).after(div);
				// clear the message after 3 seconds
				setTimeout(function(){ $('#status').remove(); }, 2000);
			}
		</script>
	</body>
</html>